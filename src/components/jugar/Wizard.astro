---
import StepModes from "./StepModes.astro";
import StepPlayers from "./StepPlayers.astro";
import StepRestrictions from "./StepRestrictions.astro";
import StepRoles from "./StepRoles.astro";
import StepSummary from "./StepSummary.astro";
---

<div id="wizard-container">
  <!-- Indicador de pasos -->
  <div class="mb-12">
    <div class="flex justify-between items-center max-w-4xl mx-auto">
      {['Jugadores', 'Modalidades', 'Roles', 'Restricciones', 'Resumen'].map((step, index) => (
        <div key={step} class="flex flex-col items-center" style={`flex: 1;`}>
          <div 
            class="step-indicator w-12 h-12 rounded-full border-2 p-2 border-gray-300 flex items-center justify-center font-bold text-gray-500 mb-2 transition-all duration-300"
            data-step={index + 1}
          >
            <span class="step-number">{index + 1}</span>
            <span class="step-checkmark hidden">✓</span>
          </div>
          <span class="step-label text-sm font-medium text-gray-600 text-center hidden md:block">
            {step}
          </span>
        </div>
      ))}
    </div>
  </div>
  
  <!-- Contenido de los pasos -->
  <div class="max-w-4xl mx-auto">
    <!-- Paso 1: Jugadores -->
    <div class="step-content" data-step="1">
      <StepPlayers />
    </div>
    
    <!-- Paso 2: Modalidades -->
    <div class="step-content" data-step="2" style="display: none;">
      <StepModes />
    </div>
    
    <!-- Paso 3: Roles -->
    <div class="step-content" data-step="3" style="display: none;">
      <StepRoles />
    </div>
    
    <!-- Paso 4: Restricciones -->
    <div class="step-content" data-step="4" style="display: none;">
      <StepRestrictions />
    </div>
    
    <!-- Paso 5: Resumen -->
    <div class="step-content" data-step="5" style="display: none;">
      <StepSummary />
    </div>
    
    <!-- Botones de navegación -->
    <div class="flex justify-between mt-12 pt-8 border-t border-gray-200">
      <button 
        id="prevBtn"
        class="btn border-2 border-gray-300 text-gray-700 hover:bg-gray-50 px-8"
        style="display: none;"
      >
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Anterior
      </button>
      
      <div class="flex-1"></div>
      
      <button 
        id="nextBtn"
        class="btn bg-gradient-to-r flex py-2 from-blue-600 to-purple-600 text-white hover:from-blue-700 hover:to-purple-700 px-8"
      >
        Siguiente
        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Estado inicial
  let gameConfig = {
    players: 6,
    maxImpostors: 2,
    selectedModes: [],
    selectedRoles: [],
    selectedRestriction: null,
    difficulty: 'media',
    showTutorial: true,
    timePerRound: 60
  };
  
  let currentStep = 1;
  const totalSteps = 5; // Cambiado a 5 pasos

  // Función para actualizar el paso
  function updateStep(step) {
    if (step < 1 || step > totalSteps) return;
    
    currentStep = step;
    updateUI();
  }

  // Función para actualizar la configuración
  function updateConfig(key, value) {
    gameConfig[key] = value;
    updateUI();
  }

  // Función para actualizar la UI
  function updateUI() {
    // Actualizar indicador de pasos
    document.querySelectorAll('.step-indicator').forEach(function(indicator, index) {
      const stepNumber = index + 1;
      const stepNumberElement = indicator.querySelector('.step-number');
      const stepCheckmark = indicator.querySelector('.step-checkmark');
      
      // Resetear todas las clases primero
      indicator.classList.remove('step-active', 'step-completed');
      
      if (stepNumber < currentStep) {
        // Paso completado
        indicator.classList.add('step-completed');
        if (stepNumberElement) stepNumberElement.classList.add('hidden');
        if (stepCheckmark) stepCheckmark.classList.remove('hidden');
      } else if (stepNumber === currentStep) {
        // Paso activo
        indicator.classList.add('step-active');
        if (stepNumberElement) {
          stepNumberElement.classList.remove('hidden');
        }
        if (stepCheckmark) stepCheckmark.classList.add('hidden');
      } else {
        // Paso pendiente
        if (stepNumberElement) {
          stepNumberElement.classList.remove('hidden');
        }
        if (stepCheckmark) stepCheckmark.classList.add('hidden');
      }
    });
    
    // Actualizar contenido del paso
    document.querySelectorAll('.step-content').forEach(function(content, index) {
      const stepNumber = index + 1;
      if (stepNumber === currentStep) {
        content.style.display = 'block';
      } else {
        content.style.display = 'none';
      }
    });
    
    // Actualizar botones
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    if (prevBtn) {
      prevBtn.style.display = currentStep === 1 ? 'none' : 'inline-flex';
    }
    
    if (nextBtn) {
      const isLastStep = currentStep === totalSteps;
      const newNextBtn = nextBtn.cloneNode(true);
      nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
      
      const updatedNextBtn = document.getElementById('nextBtn');
      if (updatedNextBtn) {
        if (isLastStep) {
          updatedNextBtn.innerHTML = 'Comenzar Partida <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>';
          updatedNextBtn.addEventListener('click', startGame);
        } else {
          updatedNextBtn.innerHTML = 'Siguiente <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>';
          updatedNextBtn.addEventListener('click', function() {
            updateStep(currentStep + 1);
          });
        }
      }
    }
    
    // Guardar en localStorage
    localStorage.setItem('impostorGameConfig', JSON.stringify(gameConfig));
  }

  // Función para empezar la partida
  function startGame() {
    console.log('Configuración final:', gameConfig);
    
    alert('¡Partida configurada!\n\nJugadores: ' + gameConfig.players + 
          '\nImpostores máx: ' + gameConfig.maxImpostors +
          '\nRoles: ' + (gameConfig.selectedRoles?.length || 0) +
          '\nRestricción: ' + (gameConfig.selectedRestriction || 'Ninguna'));
    
    // window.location.href = '/partida';
  }

  // Cargar configuración guardada
  const savedConfig = localStorage.getItem('impostorGameConfig');
  if (savedConfig) {
    try {
      const parsedConfig = JSON.parse(savedConfig);
      gameConfig = Object.assign({}, gameConfig, parsedConfig);
    } catch (error) {
      console.error('Error al cargar configuración:', error);
    }
  }
  
  // Inicializar UI
  updateUI();
  
  // Configurar botones
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  if (prevBtn) {
    prevBtn.addEventListener('click', function() {
      updateStep(currentStep - 1);
    });
  }
  
  if (nextBtn) {
    nextBtn.addEventListener('click', function() {
      if (currentStep === totalSteps) {
        startGame();
      } else {
        updateStep(currentStep + 1);
      }
    });
  }
  
  // Exponer funciones globalmente
  window.updateConfig = updateConfig;
  window.updateStep = updateStep;
  window.gameConfig = gameConfig;
});
</script>

<style>
  .step-indicator {
    transition: all 0.3s ease;
    border-color: #d1d5db !important;
    color: #6b7280;
  }
  
  .step-indicator.step-active {
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    border-color: transparent !important;
    color: white;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  
  .step-indicator.step-completed {
    background-color: #10b981;
    border-color: transparent !important;
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }
  
  .step-checkmark {
    font-weight: bold;
  }
  
  .hidden {
    display: none !important;
  }
  
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 2rem;
    border-radius: 0.75rem;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
  }
  
  .btn:hover {
    transform: translateY(-2px);
  }
</style>